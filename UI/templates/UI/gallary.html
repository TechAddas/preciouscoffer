{% extends 'UI/base.html' %}
{% load static %}

{% block content %}
<div class="banner-inner-page">
  <div class="base-container w-container">
    <div class="heading-wrapper-aligh-bottom">
      <div class="heading-inner-wrapper extra-width">
        <h1>Gallery</h1>
      </div>
      <div class="paragraph-banner-inner-wrapper">
        <p class="paragraph-large text-white">Browse project images by service category.</p>
      </div>
    </div>
  </div>
</div>

<section class="section gallery-section">
  <div class="w-layout-blockcontainer base-container w-container">
    <style>
      .navbar-main {
        background: #000 !important;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .gallery-section {
        background: #ffffff;
      }

      .gallery-filter-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 12px;
        margin-bottom: 28px;
      }

      .gallery-filter-card {
        border: 1px solid #d7d7d7;
        border-radius: 8px;
        background: #fff;
        color: #575757;
        padding: 14px;
        min-height: 68px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
        cursor: pointer;
      }

      .gallery-filter-card.active {
        border-color: #d71f2d;
        background: #fafafa;
        color: #222;
      }

      .gallery-filter-title {
        font-size: 16px;
        font-weight: 700;
        line-height: 1.2;
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 16px;
      }

      .gallery-grid-item {
        position: relative;
        overflow: hidden;
        border-radius: 2px;
      }

      .gallery-grid-link {
        display: block;
        width: 100%;
        aspect-ratio: 16 / 10;
      }

      .gallery-grid-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
      }

      .gallery-grid-item:hover .gallery-grid-photo {
        transform: scale(1.05);
      }

      .gallery-grid-label {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px 12px;
        color: #fff;
        background: linear-gradient(to top, rgba(0,0,0,0.6), rgba(0,0,0,0));
        font-size: 13px;
        font-weight: 600;
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
      }

      .gallery-grid-item:hover .gallery-grid-label {
        opacity: 1;
        transform: translateY(0);
      }

      .gallery-pagination {
        margin-top: 24px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .gallery-page-btn {
        border: 1px solid #d7d7d7;
        background: #fff;
        color: #5a5a5a;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
        cursor: pointer;
      }

      .gallery-page-btn.current {
        border-color: #d71f2d;
        color: #d71f2d;
      }

      .gallery-page-btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      @media (max-width: 991px) {
        .gallery-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 767px) {
        .gallery-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <div class="gallery-filter-cards" id="gallery-filters">
      <button type="button" class="gallery-filter-card active" data-category="all">
        <span class="gallery-filter-title">All</span>
      </button>
      {% for category in categories %}
        <button type="button" class="gallery-filter-card" data-category="{{ category.slug }}">
          <span class="gallery-filter-title">{{ category.name }}</span>
        </button>
      {% endfor %}
    </div>

    <div class="gallery-grid" id="gallery-grid">
      {% for item in images %}
        <div class="gallery-grid-item" data-gallery-item data-category="{{ item.category.slug|default:'' }}">
          <a href="#" class="gallery-grid-link w-inline-block w-lightbox" aria-label="open lightbox" aria-haspopup="dialog">
            <img src="{{ item.image.url }}" loading="lazy" alt="{{ item.project.title }} image {{ forloop.counter }}" class="gallery-grid-photo">
            <script type="application/json" class="w-json">{
  "items": [
    {
      "url": "{{ item.image.url }}",
      "type": "image"
    }
  ],
  "group": "Gallery-Grid"
}</script>
          </a>
          <div class="gallery-grid-label">
            {% if item.category %}
              {{ item.category.name }}
            {% else %}
              Gallery Image
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <p id="gallery-empty" class="paragraph-primary" style="display:none; margin-top:14px;">No images found for this category.</p>
    <div class="gallery-pagination" id="gallery-pagination"></div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const pageSize = 9;
    let currentCategory = "all";
    let currentPage = 1;

    const filterButtons = Array.from(document.querySelectorAll(".gallery-filter-card[data-category]"));
    const allItems = Array.from(document.querySelectorAll("[data-gallery-item]"));
    const grid = document.getElementById("gallery-grid");
    const emptyState = document.getElementById("gallery-empty");
    const pagination = document.getElementById("gallery-pagination");

    function filteredItems() {
      if (currentCategory === "all") return allItems;
      return allItems.filter((item) => item.dataset.category === currentCategory);
    }

    function renderPagination(totalPages) {
      pagination.innerHTML = "";
      if (totalPages <= 1) return;

      const prev = document.createElement("button");
      prev.type = "button";
      prev.className = "gallery-page-btn";
      prev.textContent = "Previous";
      prev.disabled = currentPage === 1;
      prev.addEventListener("click", function () {
        if (currentPage > 1) {
          currentPage -= 1;
          render();
        }
      });
      pagination.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        if (i < currentPage - 2 || i > currentPage + 2) continue;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "gallery-page-btn" + (i === currentPage ? " current" : "");
        btn.textContent = String(i);
        btn.addEventListener("click", function () {
          currentPage = i;
          render();
        });
        pagination.appendChild(btn);
      }

      const next = document.createElement("button");
      next.type = "button";
      next.className = "gallery-page-btn";
      next.textContent = "Next";
      next.disabled = currentPage === totalPages;
      next.addEventListener("click", function () {
        if (currentPage < totalPages) {
          currentPage += 1;
          render();
        }
      });
      pagination.appendChild(next);
    }

    function render() {
      const items = filteredItems();
      const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      allItems.forEach((item) => {
        item.style.display = "none";
      });

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      items.slice(start, end).forEach((item) => {
        item.style.display = "";
      });

      emptyState.style.display = items.length ? "none" : "";
      renderPagination(totalPages);
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        filterButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentCategory = btn.dataset.category;
        currentPage = 1;
        render();
      });
    });

    render();
  });
</script>
{% endblock %}
